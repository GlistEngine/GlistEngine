name: Build Windows

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - name: Checkout GlistEngine
        uses: actions/checkout@v4

      - name: Set up directory structure
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "C:\dev\glist\myglistapps"
          New-Item -ItemType Directory -Force -Path "C:\dev\glist\zbin"
          New-Item -ItemType Junction -Path "C:\dev\glist\GlistEngine" -Target $env:GITHUB_WORKSPACE

      - name: Get glistzbin-win64 release info
        id: zbin-info
        shell: pwsh
        run: |
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/GlistEngine/glistzbin-win64/releases/latest" -Headers @{ Authorization = "token ${{ github.token }}" }
          $tag = $release.tag_name
          $url = $release.assets[0].browser_download_url
          
          echo "TAG: $tag"
          echo "URL: $url"
          
          "tag=$tag" >> $env:GITHUB_OUTPUT
          "url=$url" >> $env:GITHUB_OUTPUT

      - name: Restore glistzbin-win64 cache
        id: cache-zbin
        uses: actions/cache/restore@v4
        with:
          path: C:\dev\glist\zbin\glistzbin-win64
          key: glistzbin-win64-${{ steps.zbin-info.outputs.tag }}

      - name: Download and extract glistzbin-win64
        if: steps.cache-zbin.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ steps.zbin-info.outputs.url }}" -OutFile "C:\dev\glist\zbin\glistzbin-win64.zip"
          Expand-Archive -Path "C:\dev\glist\zbin\glistzbin-win64.zip" -DestinationPath "C:\dev\glist\zbin\"
          # Rename versioned folder to the expected name if needed
          $extracted = Get-ChildItem -Path "C:\dev\glist\zbin" -Directory |
            Where-Object { $_.Name -like "glistzbin-win64*" } |
            Select-Object -First 1

      - name: Add clang64 to PATH
        shell: pwsh
        run: |
          # clang64/bin must be in PATH so the linker and supporting tools are found.
          "C:\dev\glist\zbin\glistzbin-win64\clang64\bin" >> $env:GITHUB_PATH

      - name: Clone GlistApp
        run: git clone https://github.com/GlistEngine/GlistApp.git C:\dev\glist\myglistapps\GlistApp

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake `
          -S C:\dev\glist\myglistapps\GlistApp `
          -B C:\dev\glist\myglistapps\GlistApp\cmake-build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Debug `
          -DCMAKE_C_COMPILER=C:/dev/glist/zbin/glistzbin-win64/clang64/bin/clang.exe `
          -DCMAKE_CXX_COMPILER=C:/dev/glist/zbin/glistzbin-win64/clang64/bin/clang++.exe `
          -DCMAKE_C_COMPILER_TARGET=x86_64-w64-windows-gnu `
          -DCMAKE_CXX_COMPILER_TARGET=x86_64-w64-windows-gnu `
          -DCMAKE_SYSROOT=C:/dev/glist/zbin/glistzbin-win64/clang64 `
          -DCMAKE_EXE_LINKER_FLAGS="--sysroot=C:/dev/glist/zbin/glistzbin-win64/clang64"

      - name: Build
        shell: pwsh
        run: cmake --build C:\dev\glist\myglistapps\GlistApp\cmake-build --parallel $env:NUMBER_OF_PROCESSORS

      - name: Save glistzbin-win64 cache
        if: github.ref == 'refs/heads/main' && steps.cache-zbin.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: C:\dev\glist\zbin\glistzbin-win64
          key: glistzbin-win64-${{ steps.zbin-info.outputs.tag }}
